var je=Object.defineProperty,pe=Object.defineProperties;var ge=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var Y=(s,n,t)=>n in s?je(s,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[n]=t,j=(s,n)=>{for(var t in n||(n={}))fe.call(n,t)&&Y(s,t,n[t]);if(W)for(var t of W(n))_e.call(n,t)&&Y(s,t,n[t]);return s},M=(s,n)=>pe(s,ge(n));var A=(s,n,t)=>new Promise((c,f)=>{var m=o=>{try{r(t.next(o))}catch(_){f(_)}},h=o=>{try{r(t.throw(o))}catch(_){f(_)}},r=o=>o.done?c(o.value):Promise.resolve(o.value).then(m,h);r((t=t.apply(s,n)).next())});import{j as e}from"./ui-DslYdUPK.js";import{r as g}from"./router-42GXI50n.js";import{u as ve}from"./useIncidents-Bx07qVBD.js";import{u as be}from"./useServices-CHToQZU2.js";import{s as p,u as ie,B as F,a as we,v as Ce,w as Se,C as G,n as J,S as Q,p as X,m as De,o as Ne,O as Te,x as ye,e as Ie,V as Fe,W as Ae,Y as Le,a0 as Z,_ as Oe,A as Ve,f as ke,g as Ee,h as Me,i as qe,j as He,k as ze,l as Be,d as L,K as q}from"./index-Cw6WSGfP.js";import{u as Pe,t as Re,F as Ue,a as v,b,c as w,d as C,e as S,o as $e,s as T,f as Ke}from"./form-Ba3HuSxU.js";import{I as ee}from"./input-B7M3MPRI.js";import{T as se}from"./textarea-BGhclJcN.js";import{S as H,a as z,b as B,c as P,d as D}from"./select-NjfxA5eB.js";import{T as We,a as Ye,b as te,c as re}from"./tabs-SYysrnpz.js";import{T as Ge,a as Je,b as ae,c as y,d as Qe,e as I}from"./table-BD6NPv27.js";import{D as Xe,a as Ze,b as es,c as ss,d as ts}from"./dialog-DtG0Tqk0.js";import{C as rs}from"./circle-plus-CGDpU3lh.js";import{C as as}from"./chevron-up-3WKbjQ45.js";import{E as is}from"./ellipsis-pwK6sJe6.js";import{S as ls}from"./square-pen-ltNotjoP.js";import{f as ns}from"./format-ulCIpsJ0.js";import"./vendor-aQ18W7Az.js";import"./streaming-fF1zHaJi.js";import"./utils-D-N2hrcs.js";import"./label-BjJg9FZ3.js";import"./index-Cco2FRbQ.js";const os=()=>{const[s,n]=g.useState([]),[t,c]=g.useState(!0);return g.useEffect(()=>{A(null,null,function*(){c(!0);const{data:m,error:h}=yield p.from("profiles").select("*").eq("role","admin");h?(console.error("Error fetching admins:",h),n([])):n(m||[]),c(!1)})},[]),{admins:s,loading:t}},cs=$e({title:T().min(1,{message:"Le titre est requis"}),description:T().min(1,{message:"La description est requise"}),title_en:T().nullable().optional(),description_en:T().nullable().optional(),status:Ke(["investigating","identified","monitoring","resolved"]),service_id:T().nullable(),author_id:T().uuid("L'auteur est requis.")}),ds=({incident:s,services:n,admins:t,currentUserId:c,onSubmit:f,onCancel:m,isSubmitting:h})=>{const{t:r}=ie(),o=Pe({resolver:Re(cs),defaultValues:{title:(s==null?void 0:s.title)||"",description:(s==null?void 0:s.description)||"",title_en:(s==null?void 0:s.title_en)||"",description_en:(s==null?void 0:s.description_en)||"",status:(s==null?void 0:s.status)||"investigating",service_id:(s==null?void 0:s.service_id)||null,author_id:(s==null?void 0:s.author_id)||c}}),_=i=>{const l=j({},i);i.status==="resolved"&&(!s||s.status!=="resolved")?l.resolved_at=new Date().toISOString():i.status!=="resolved"&&(l.resolved_at=null),f(l)};return e.jsx(Ue,M(j({},o),{children:e.jsxs("form",{onSubmit:o.handleSubmit(_),className:"space-y-4",children:[e.jsxs(We,{defaultValue:"fr",className:"w-full",children:[e.jsxs(Ye,{className:"grid w-full grid-cols-2",children:[e.jsx(te,{value:"fr",children:"Français"}),e.jsx(te,{value:"en",children:"English"})]}),e.jsxs(re,{value:"fr",className:"space-y-4 pt-4",children:[e.jsx(v,{control:o.control,name:"title",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("title")}),e.jsx(C,{children:e.jsx(ee,j({},i))}),e.jsx(S,{})]})}),e.jsx(v,{control:o.control,name:"description",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("description")}),e.jsx(C,{children:e.jsx(se,j({},i))}),e.jsx(S,{})]})})]}),e.jsxs(re,{value:"en",className:"space-y-4 pt-4",children:[e.jsx(v,{control:o.control,name:"title_en",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("title")}),e.jsx(C,{children:e.jsx(ee,j({},i))}),e.jsx(S,{})]})}),e.jsx(v,{control:o.control,name:"description_en",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("description")}),e.jsx(C,{children:e.jsx(se,j({},i))}),e.jsx(S,{})]})})]})]}),e.jsx(v,{control:o.control,name:"status",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("status")}),e.jsxs(H,{onValueChange:i.onChange,defaultValue:i.value,children:[e.jsx(C,{children:e.jsx(z,{children:e.jsx(B,{placeholder:r("status")})})}),e.jsxs(P,{children:[e.jsx(D,{value:"investigating",children:r("investigating")}),e.jsx(D,{value:"identified",children:r("identified")}),e.jsx(D,{value:"monitoring",children:r("monitoring")}),e.jsx(D,{value:"resolved",children:r("resolved")})]})]}),e.jsx(S,{})]})}),e.jsx(v,{control:o.control,name:"service_id",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("service")}),e.jsxs(H,{onValueChange:l=>i.onChange(l==="null"?null:l),defaultValue:i.value||"null",children:[e.jsx(C,{children:e.jsx(z,{children:e.jsx(B,{placeholder:r("service")})})}),e.jsxs(P,{children:[e.jsx(D,{value:"null",children:r("no_service_affected")}),n.map(l=>e.jsx(D,{value:l.id,children:r(l.name.toLowerCase().replace(/ /g,"_"))},l.id))]})]}),e.jsx(S,{})]})}),e.jsx(v,{control:o.control,name:"author_id",render:({field:i})=>e.jsxs(b,{children:[e.jsx(w,{children:r("assign_to")}),e.jsxs(H,{onValueChange:i.onChange,defaultValue:i.value||void 0,children:[e.jsx(C,{children:e.jsx(z,{children:e.jsx(B,{placeholder:r("select_admin")})})}),e.jsx(P,{children:t.map(l=>e.jsx(D,{value:l.id,children:`${l.first_name||""} ${l.last_name||""}`.trim()||l.email},l.id))})]}),e.jsx(S,{})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(F,{type:"button",variant:"ghost",onClick:m,disabled:h,children:r("cancel")}),e.jsx(F,{type:"submit",disabled:h,children:r(h?"saving":"save")})]})]})}))},ks=()=>{const{t:s,i18n:n}=ie(),{session:t}=we(),{incidents:c,loading:f,refreshIncidents:m}=ve(),{services:h,loading:r}=be(),{admins:o,loading:_}=os(),[i,l]=g.useState(!1),[le,R]=g.useState(!1),[x,V]=g.useState(null),[ne,k]=g.useState(!1),[O,E]=g.useState(null),oe=n.language==="fr"?Ce:Se,U={investigating:{text:s("investigating"),className:"bg-blue-500/20 text-blue-500 border-blue-500/30"},identified:{text:s("identified"),className:"bg-yellow-500/20 text-yellow-500 border-yellow-500/30"},monitoring:{text:s("monitoring"),className:"bg-purple-500/20 text-purple-500 border-purple-500/30"},resolved:{text:s("resolved"),className:"bg-green-500/20 text-green-500 border-green-500/30"}},$=(a,u)=>A(null,null,function*(){const d=c[a],N=u==="up"?a-1:a+1,K=c[N];if(!d||!K)return;const{error:xe}=yield p.rpc("swap_incident_positions",{incident_id_1:d.id,incident_id_2:K.id});xe?L("Erreur lors de la réorganisation."):m()}),ce=a=>A(null,null,function*(){if(!(t!=null&&t.user)){L("Vous devez être connecté pour effectuer cette action.");return}R(!0);const u=M(j({},a),{title_en:a.title_en||null,description_en:a.description_en||null,updated_at:new Date().toISOString(),position:x?x.position:c.length>0?Math.max(...c.map(d=>d.position))+1:1});if(x){const{error:d}=yield p.from("incidents").update(u).eq("id",x.id);d?(L(s("error_saving_incident")),console.error(d)):(q(s("incident_saved_successfully")),t!=null&&t.user.id&&(yield p.from("audit_logs").insert({user_id:t.user.id,action:"incident_updated",details:{incident_id:x.id,title:a.title}})),m())}else{const{data:d,error:N}=yield p.from("incidents").insert(u).select().single();N?(L(s("error_saving_incident")),console.error(N)):(q(s("incident_saved_successfully")),d&&(t!=null&&t.user.id)&&(yield p.from("audit_logs").insert({user_id:t.user.id,action:"incident_created",details:{incident_id:d.id,title:a.title}})),m())}l(!1),V(null),R(!1)}),de=a=>{E(a),k(!0)},ue=()=>A(null,null,function*(){var d;if(!O)return;const a=(d=c.find(N=>N.id===O))==null?void 0:d.title,{error:u}=yield p.from("incidents").delete().eq("id",O);u?(L(s("error_deleting_incident")),console.error(u)):(q(s("incident_deleted_successfully")),t!=null&&t.user.id&&(yield p.from("audit_logs").insert({user_id:t.user.id,action:"incident_deleted",details:{incident_id:O,title:a}})),m()),k(!1),E(null)}),me=()=>{V(null),l(!0)},he=a=>{V(a),l(!0)};return f||r||_?e.jsxs(G,{children:[e.jsx(J,{children:e.jsx(Q,{className:"h-8 w-48"})}),e.jsx(X,{children:e.jsx(Q,{className:"h-96 w-full"})})]}):e.jsxs(De.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeInOut"},children:[e.jsxs(G,{children:[e.jsxs(J,{className:"flex flex-row items-center justify-between",children:[e.jsx(Ne,{children:s("manage_incidents")}),e.jsxs(F,{onClick:me,children:[e.jsx(rs,{className:"mr-2 h-4 w-4"}),s("create_incident")]})]}),e.jsx(X,{children:e.jsxs(Ge,{children:[e.jsx(Je,{children:e.jsxs(ae,{children:[e.jsx(y,{className:"w-[60px]",children:"Ordre"}),e.jsx(y,{children:s("title")}),e.jsx(y,{children:s("status")}),e.jsx(y,{children:s("service")}),e.jsx(y,{children:s("last_updated")}),e.jsx(y,{className:"text-right",children:s("actions")})]})}),e.jsx(Qe,{children:c.map((a,u)=>e.jsxs(ae,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(F,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>$(u,"up"),disabled:u===0,"aria-label":"Déplacer vers le haut",children:e.jsx(as,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>$(u,"down"),disabled:u===c.length-1,"aria-label":"Déplacer vers le bas",children:e.jsx(Te,{className:"h-4 w-4"})})]})}),e.jsx(I,{className:"font-medium",children:a.title}),e.jsx(I,{children:e.jsx(ye,{variant:"outline",className:Ie("border",U[a.status].className),children:U[a.status].text})}),e.jsx(I,{children:a.services?s(a.services.name.toLowerCase().replace(/ /g,"_")):s("system_wide_incident")}),e.jsx(I,{children:ns(new Date(a.updated_at),"PP",{locale:oe})}),e.jsx(I,{className:"text-right",children:e.jsxs(Fe,{modal:!1,children:[e.jsx(Ae,{asChild:!0,children:e.jsx(F,{variant:"ghost",size:"icon","aria-label":"Actions pour cet incident",children:e.jsx(is,{className:"h-4 w-4"})})}),e.jsxs(Le,{align:"end",children:[e.jsxs(Z,{onClick:()=>he(a),children:[e.jsx(ls,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:s("edit")})]}),e.jsxs(Z,{onClick:()=>de(a.id),className:"text-destructive",children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:s("delete")})]})]})]})})]},a.id))})]})})]}),e.jsx(Xe,{open:i,onOpenChange:l,children:e.jsxs(Ze,{className:"sm:max-w-lg w-full",children:[e.jsxs(es,{children:[e.jsx(ss,{children:s(x?"edit_incident":"create_incident")}),e.jsx(ts,{children:s(x?"edit_incident_desc":"create_incident_desc")})]}),e.jsx(ds,{incident:x,services:h,admins:o,currentUserId:t.user.id,onSubmit:ce,onCancel:()=>l(!1),isSubmitting:le})]})}),e.jsx(Ve,{open:ne,onOpenChange:k,children:e.jsxs(ke,{children:[e.jsxs(Ee,{children:[e.jsx(Me,{children:s("confirm_delete_title")}),e.jsx(qe,{children:s("confirm_delete_incident")})]}),e.jsxs(He,{children:[e.jsx(ze,{onClick:()=>E(null),children:s("cancel")}),e.jsx(Be,{onClick:ue,className:"bg-destructive hover:bg-destructive/90",children:s("delete")})]})]})})]})};export{ks as default};
//# sourceMappingURL=IncidentManager-CMHY6MNf.js.map
