var Oe=Object.defineProperty,Ve=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var He=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable;var Z=(a,n,r)=>n in a?Oe(a,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[n]=r,g=(a,n)=>{for(var r in n||(n={}))He.call(n,r)&&Z(a,r,n[r]);if(Y)for(var r of Y(n))qe.call(n,r)&&Z(a,r,n[r]);return a},Q=(a,n)=>Ve(a,Ee(n));var _=(a,n,r)=>new Promise((o,u)=>{var c=d=>{try{f(r.next(d))}catch(p){u(p)}},B=d=>{try{f(r.throw(d))}catch(p){u(p)}},f=d=>d.done?o(d.value):Promise.resolve(d.value).then(c,B);f((r=r.apply(a,n)).next())});import{j as e}from"./ui-DslYdUPK.js";import{r as m,L as X}from"./router-42GXI50n.js";import{u as Be}from"./useUsers-BIS_RP8_.js";import{c as Pe,u as pe,B as x,a as Re,v as ze,w as Ge,s as h,d as C,C as ee,n as se,S as ae,p as re,m as Je,o as Ke,D as We,E as Ye,G as Ze,H as Qe,x as le,T as Xe,q as es,r as ss,V as as,W as rs,Y as ls,a0 as w,a2 as te,aa as ts,ab as ns,P as ne,ac as is,ad as os,$ as cs,_ as ds,A as ie,f as oe,g as ce,h as de,i as me,j as ue,k as he,l as xe,ae as ms,K as E,af as us}from"./index-Cw6WSGfP.js";import{T as hs,a as xs,b as je,c as v,d as js,e as y}from"./table-BD6NPv27.js";import{I as T}from"./input-B7M3MPRI.js";import{S as ge,a as _e,b as we,c as be,d as A}from"./select-NjfxA5eB.js";import{D as fs,a as ps,b as gs,c as _s,d as ws}from"./dialog-DtG0Tqk0.js";import{u as bs,t as Cs,F as vs,a as S,b as N,c as D,d as k,e as M,o as ys,f as Ss,s as H}from"./form-Ba3HuSxU.js";import{C as Ns}from"./circle-plus-CGDpU3lh.js";import{S as Ds}from"./search-DTGOIQkO.js";import{E as fe}from"./ellipsis-pwK6sJe6.js";import{S as ks}from"./square-pen-ltNotjoP.js";import{S as Ms}from"./shield-off-VgMbnC9R.js";import{f as Ts}from"./format-ulCIpsJ0.js";import"./vendor-aQ18W7Az.js";import"./streaming-fF1zHaJi.js";import"./utils-D-N2hrcs.js";import"./index-Cco2FRbQ.js";import"./label-BjJg9FZ3.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=Pe("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]),As=ys({first_name:H().min(1,{message:"Le prénom est requis"}),last_name:H().min(1,{message:"Le nom est requis"}),email:H().email({message:"L'adresse e-mail n'est pas valide"}),password:H().min(6,{message:"Le mot de passe doit faire au moins 6 caractères."}).regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$/,{message:"Doit contenir une majuscule, une minuscule et un chiffre."}),role:Ss(["user","admin"])}),Is=({onSubmit:a,onCancel:n,isSubmitting:r})=>{const{t:o}=pe(),u=bs({resolver:Cs(As),defaultValues:{first_name:"",last_name:"",email:"",password:"",role:"user"}});return e.jsx(vs,Q(g({},u),{children:e.jsxs("form",{onSubmit:u.handleSubmit(a),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(S,{control:u.control,name:"first_name",render:({field:c})=>e.jsxs(N,{children:[e.jsx(D,{children:o("first_name")}),e.jsx(k,{children:e.jsx(T,g({},c))}),e.jsx(M,{})]})}),e.jsx(S,{control:u.control,name:"last_name",render:({field:c})=>e.jsxs(N,{children:[e.jsx(D,{children:o("last_name")}),e.jsx(k,{children:e.jsx(T,g({},c))}),e.jsx(M,{})]})})]}),e.jsx(S,{control:u.control,name:"email",render:({field:c})=>e.jsxs(N,{children:[e.jsx(D,{children:o("email_address")}),e.jsx(k,{children:e.jsx(T,g({type:"email"},c))}),e.jsx(M,{})]})}),e.jsx(S,{control:u.control,name:"password",render:({field:c})=>e.jsxs(N,{children:[e.jsx(D,{children:o("password")}),e.jsx(k,{children:e.jsx(T,g({type:"password"},c))}),e.jsx(M,{})]})}),e.jsx(S,{control:u.control,name:"role",render:({field:c})=>e.jsxs(N,{children:[e.jsx(D,{children:o("role")}),e.jsxs(ge,{onValueChange:c.onChange,defaultValue:c.value,children:[e.jsx(k,{children:e.jsx(_e,{children:e.jsx(we,{placeholder:o("role")})})}),e.jsxs(be,{children:[e.jsx(A,{value:"user",children:o("user_role")}),e.jsx(A,{value:"admin",children:o("admin_role")})]})]}),e.jsx(M,{})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"ghost",onClick:n,disabled:r,children:o("cancel")}),e.jsx(x,{type:"submit",disabled:r,children:o(r?"saving":"save")})]})]})}))},ea=()=>{const{t:a,i18n:n}=pe(),{session:r}=Re(),{users:o,loading:u,refreshUsers:c}=Be(),[B,f]=m.useState(!1),[d,p]=m.useState(null),[Ce,P]=m.useState(!1),[j,R]=m.useState(null),[I,ve]=m.useState([]),[ye,G]=m.useState(!0),[Se,U]=m.useState(!1),[Ne,J]=m.useState(!1),[F,De]=m.useState("all"),[$,ke]=m.useState(""),[b,Me]=m.useState("updated_at"),[L,K]=m.useState("desc"),Te=n.language==="fr"?ze:Ge,z=m.useCallback(()=>_(null,null,function*(){G(!0);try{const{data:s,error:l}=yield h.functions.invoke("get-mfa-factors");if(l)throw l;ve(s.userIds||[])}catch(s){console.error("Error fetching MFA status:",s),C(a("error_fetching_mfa_status"))}finally{G(!1)}}),[a]);m.useEffect(()=>{z()},[z]);const Ae=m.useMemo(()=>o.filter(s=>{var l;if(F!=="all"&&s.role!==F)return!1;if($){const t=$.toLowerCase(),i=`${s.first_name||""} ${s.last_name||""}`.toLowerCase(),V=((l=s.email)==null?void 0:l.toLowerCase())||"";if(!i.includes(t)&&!V.includes(t))return!1}return!0}).sort((s,l)=>{let t,i;switch(b){case"mfa":t=I.includes(s.id),i=I.includes(l.id);break;case"first_name":t=`${s.first_name||""} ${s.last_name||""}`,i=`${l.first_name||""} ${l.last_name||""}`;break;default:t=s[b]||"",i=l[b]||""}return t<i?L==="asc"?-1:1:t>i?L==="asc"?1:-1:0}),[o,F,$,b,L,I]),O=s=>{b===s?K(L==="asc"?"desc":"asc"):(Me(s),K("desc"))},Ie=s=>{p(s),f(!0)},Ue=()=>_(null,null,function*(){if(!(!d||!(r!=null&&r.user)))try{const{error:s}=yield h.functions.invoke("delete-user",{body:{userId:d.id}});if(s)throw s;E(a("user_deleted_successfully")),yield h.from("audit_logs").insert({user_id:r.user.id,action:"user_deleted",details:{deleted_user_id:d.id,email:d.email}}),c()}catch(s){C(`${a("error_deleting_user")}: ${s.message}`)}finally{f(!1),p(null)}}),W=(s,l)=>_(null,null,function*(){if(!(r!=null&&r.user))return;const{error:t}=yield h.from("profiles").update({role:l}).eq("id",s);t?C(a("error_updating_role")):(E(a("role_updated_successfully")),yield h.from("audit_logs").insert({user_id:r.user.id,action:"user_role_changed",details:{target_user_id:s,new_role:l}}),c())}),Fe=s=>{R(s),P(!0)},$e=()=>_(null,null,function*(){if(!(!j||!(r!=null&&r.user)))try{const{error:s}=yield h.functions.invoke("admin-unenroll-mfa",{body:{userId:j.id}});if(s)throw s;E(a("mfa_disabled_for_user",{email:j.email})),yield h.from("audit_logs").insert({user_id:r.user.id,action:"admin_mfa_disabled",details:{target_user_id:j.id,email:j.email}}),z()}catch(s){C(`${a("error_disabling_mfa")}: ${s.message}`)}finally{P(!1),R(null)}}),Le=s=>_(null,null,function*(){if(r!=null&&r.user){J(!0);try{const{data:l,error:t}=yield h.functions.invoke("create-user",{body:s});if(t)throw t;const i=l.user;E(a("user_created_successfully",{email:s.email})),i!=null&&i.id&&(yield h.from("audit_logs").insert({user_id:r.user.id,action:"user_created_by_admin",details:{new_user_id:i.id,email:s.email,role:s.role}})),c(),U(!1)}catch(l){console.error("create-user invoke error:",l);let t=l.message;if(l instanceof us)try{t=(yield l.context.json()).error||t}catch(i){}C(`Erreur lors de la création de l'utilisateur: ${t}`)}finally{J(!1)}}});return u||ye?e.jsxs(ee,{children:[e.jsx(se,{children:e.jsx(ae,{className:"h-8 w-48"})}),e.jsx(re,{children:e.jsx(ae,{className:"h-96 w-full"})})]}):e.jsxs(Je.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeInOut"},children:[e.jsxs(ee,{children:[e.jsxs(se,{className:"flex flex-row items-center justify-between",children:[e.jsx(Ke,{children:a("manage_users")}),e.jsxs(x,{onClick:()=>U(!0),children:[e.jsx(Ns,{className:"mr-2 h-4 w-4"}),"Créer un utilisateur"]})]}),e.jsxs(re,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"relative w-full sm:w-auto sm:flex-grow max-w-sm",children:[e.jsx(Ds,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(T,{placeholder:a("search_user_placeholder"),value:$,onChange:s=>ke(s.target.value),className:"pl-10"})]}),e.jsx("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:e.jsxs(ge,{value:F,onValueChange:s=>De(s),children:[e.jsx(_e,{className:"w-full sm:w-[180px]",children:e.jsx(we,{placeholder:a("filter_by_role")})}),e.jsxs(be,{children:[e.jsx(A,{value:"all",children:a("all_roles")}),e.jsx(A,{value:"admin",children:a("admin_role")}),e.jsx(A,{value:"user",children:a("user_role")})]})]})})]}),e.jsxs(hs,{children:[e.jsx(xs,{children:e.jsxs(je,{children:[e.jsx(v,{children:e.jsxs(x,{variant:"ghost",onClick:()=>O("first_name"),children:[a("user_header")," ",e.jsx(q,{className:"ml-2 h-4 w-4"})]})}),e.jsx(v,{children:e.jsxs(x,{variant:"ghost",onClick:()=>O("role"),children:[a("role")," ",e.jsx(q,{className:"ml-2 h-4 w-4"})]})}),e.jsx(v,{children:e.jsxs(x,{variant:"ghost",onClick:()=>O("mfa"),children:["MFA ",e.jsx(q,{className:"ml-2 h-4 w-4"})]})}),e.jsx(v,{children:e.jsxs(x,{variant:"ghost",onClick:()=>O("updated_at"),children:[a("last_update")," ",e.jsx(q,{className:"ml-2 h-4 w-4"})]})}),e.jsx(v,{className:"text-right",children:a("actions")})]})}),e.jsx(js,{children:Ae.map(s=>{var i,V;const l=I.includes(s.id),t=s.id===((i=r==null?void 0:r.user)==null?void 0:i.id);return e.jsxs(je,{className:t?"bg-muted/50":"",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(We,{className:"h-9 w-9",children:[e.jsx(Ye,{src:s.avatar_url||Ze(s.email)}),e.jsx(Qe,{children:(V=s.email)==null?void 0:V[0].toUpperCase()})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[s.first_name," ",s.last_name]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.email})]})]})}),e.jsx(y,{children:e.jsx(le,{variant:s.role==="admin"?"default":"secondary",children:s.role==="admin"?a("admin_role"):a("user_role")})}),e.jsx(y,{children:e.jsx(le,{variant:l?"default":"outline",className:l?"bg-green-500/20 text-green-500 border-green-500/30":"",children:a(l?"mfa_enabled":"mfa_disabled")})}),e.jsx(y,{children:Ts(new Date(s.updated_at),"PP",{locale:Te})}),e.jsx(y,{className:"text-right",children:t?e.jsxs(Xe,{children:[e.jsx(es,{asChild:!0,children:e.jsx("span",{tabIndex:0,children:e.jsx(x,{variant:"ghost",size:"icon",disabled:!0,children:e.jsx(fe,{className:"h-4 w-4"})})})}),e.jsx(ss,{children:e.jsx("p",{children:a("cannot_edit_self_tooltip")})})]}):e.jsxs(as,{modal:!1,children:[e.jsx(rs,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",children:e.jsx(fe,{className:"h-4 w-4"})})}),e.jsxs(ls,{align:"end",children:[e.jsx(w,{asChild:!0,children:e.jsxs(X,{to:`/profile/${s.id}`,className:"cursor-pointer",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Voir le profil"})]})}),e.jsx(w,{asChild:!0,children:e.jsxs(X,{to:`/admin/users/${s.id}/edit`,className:"cursor-pointer",children:[e.jsx(ks,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:a("edit")})]})}),e.jsxs(ts,{children:[e.jsxs(ns,{children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:a("role")})]}),e.jsx(is,{children:e.jsxs(os,{children:[e.jsxs(w,{onClick:()=>W(s.id,"admin"),children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),a("admin_role")]}),e.jsxs(w,{onClick:()=>W(s.id,"user"),children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),a("user_role")]})]})})]}),e.jsxs(w,{onClick:()=>Fe(s),disabled:!l,children:[e.jsx(Ms,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:a("disable_mfa")})]}),e.jsx(cs,{}),e.jsxs(w,{onClick:()=>Ie(s),className:"text-destructive",children:[e.jsx(ds,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:a("delete")})]})]})]})})]},s.id)})})]})]})]}),e.jsx(fs,{open:Se,onOpenChange:U,children:e.jsxs(ps,{className:"sm:max-w-lg",children:[e.jsxs(gs,{children:[e.jsx(_s,{children:"Créer un nouvel utilisateur"}),e.jsx(ws,{children:"Remplissez les informations ci-dessous. Un e-mail de confirmation sera envoyé à l'utilisateur."})]}),e.jsx(Is,{onSubmit:Le,onCancel:()=>U(!1),isSubmitting:Ne})]})}),e.jsx(ie,{open:B,onOpenChange:f,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:a("confirm_delete_title")}),e.jsx(me,{children:a("confirm_delete_user",{email:d==null?void 0:d.email})})]}),e.jsxs(ue,{children:[e.jsx(he,{onClick:()=>p(null),children:a("cancel")}),e.jsx(xe,{onClick:Ue,className:"bg-destructive hover:bg-destructive/90",children:a("delete")})]})]})}),e.jsx(ie,{open:Ce,onOpenChange:P,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:a("confirm_disable_mfa_title")}),e.jsx(me,{children:a("confirm_disable_mfa_desc",{email:j==null?void 0:j.email})})]}),e.jsxs(ue,{children:[e.jsx(he,{onClick:()=>R(null),children:a("cancel")}),e.jsx(xe,{onClick:$e,className:ms({variant:"destructive"}),children:a("disable_mfa")})]})]})})]})};export{ea as default};
//# sourceMappingURL=UserManager-DmQ1vJZj.js.map
