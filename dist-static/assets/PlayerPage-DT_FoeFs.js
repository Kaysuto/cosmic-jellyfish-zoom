var O=(r,s,f)=>new Promise((g,T)=>{var u=y=>{try{h(f.next(y))}catch(v){T(v)}},S=y=>{try{h(f.throw(y))}catch(v){T(v)}},h=y=>y.done?g(y.value):Promise.resolve(y.value).then(u,S);h((f=f.apply(r,s)).next())});import{j as a}from"./ui-DslYdUPK.js";import{r as i,h as ae,u as ne,d as oe,i as ie}from"./router-42GXI50n.js";import{u as Z,B as le,d as ce,a as de,b as ue,aD as P,s as _,S as me,af as fe}from"./index-Cw6WSGfP.js";import{M as pe,a as be,b as ge,T as K}from"./streaming-fF1zHaJi.js";import{A as he}from"./arrow-left-Db81hexG.js";import{A as Q,a as W,b as X}from"./alert-C5VW6aHR.js";import{T as Y}from"./triangle-alert-bjg6MAJf.js";import"./vendor-aQ18W7Az.js";import"./utils-D-N2hrcs.js";const ye=({src:r,title:s,container:f,chapters:g,subtitleTracks:T,startTime:u,onTimeUpdate:S,onDurationChange:h,selectedSubtitleIndex:y,onBack:v})=>{const w=i.useRef(null),{t:L}=Z(),A=k=>{const l=w.current;if(!l)return;const G=l.textTracks.getByKind("chapters");for(const e of G)l.textTracks.remove(e);const j=new K({kind:"chapters",default:!0,label:"Chapters"});if(Array.isArray(g)&&g.length>0)for(let e=0;e<g.length;e++){const p=g[e],o=g[e+1],C=Number((p==null?void 0:p.StartPositionTicks)||0)/1e7,U=o?Number((o==null?void 0:o.StartPositionTicks)||0)/1e7:l.duration;if(isNaN(C)||isNaN(U)||C>=U)continue;const I=p!=null&&p.Name&&String(p.Name).trim().length>0?String(p.Name):`Chapitre ${e+1}`;j.addCue(new window.VTTCue(C,U,I))}else if(!isNaN(l.duration)&&l.duration>0){const e=l.duration,p=[{s:0,e:Math.min(e*.5,e),label:"Début"},{s:Math.min(e*.5,e-1),e:Math.min(e*.9,e),label:"Milieu"},{s:Math.min(e*.9,e-1),e,label:"Générique"}];for(const o of p)!isNaN(o.s)&&!isNaN(o.e)&&o.s<o.e&&j.addCue(new window.VTTCue(o.s,o.e,o.label))}if(j.cues.length>0&&l.textTracks.add(j),T&&T.length>0)for(const e of T){const p=y?e.Index.toString()===y:!1,o=new K({src:e.src,kind:"subtitles",label:e.DisplayTitle,language:e.Language,default:p});l.textTracks.add(o)}if(typeof u=="number"&&!isNaN(u)&&u>0)try{l.currentTime=u}catch(e){}};if(!r)return null;const V={src:r,type:f?`video/${f.toLowerCase()}`:void 0};function R(k){if(w.current&&typeof u=="number"&&!isNaN(u)){const l=w.current.currentTime;Math.abs(l-u)>.5&&(w.current.currentTime=u)}}function z(k){const l=k.detail;ce(`Erreur lecteur vidéo: ${l.message}`)}function q(k){S&&S(k.detail.currentTime)}function F(k){h&&h(k.detail.duration)}function J(k){window.dispatchEvent(new CustomEvent("playback-ended"))}return a.jsxs(pe,{ref:w,className:"w-full max-h-screen group",title:s,src:V,playsInline:!0,autoPlay:!0,load:"eager",crossOrigin:!0,onCanPlay:R,onError:z,onTimeUpdate:q,onDurationChange:F,onLoadedMetadata:A,onEnded:J,aspectRatio:16/9,children:[a.jsx(be,{}),a.jsx(ge,{}),a.jsx(le,{variant:"ghost",size:"icon",onClick:v,className:"absolute top-4 left-4 z-20 text-white bg-black/50 hover:bg-black/75 hover:text-white rounded-full transition-opacity opacity-0 group-hover:opacity-100 focus:opacity-100","aria-label":L("back"),children:a.jsx(he,{className:"h-5 w-5"})})]},r)},Ie=()=>{const{mediaType:r,tmdbId:s}=ae(),f=ne(),g=oe(),{t:T}=Z(),{session:u}=de(),{error:S}=ue(),[h]=ie(),y=h.get("t"),v=h.get("audioStreamIndex"),w=h.get("subtitleStreamIndex"),[L,A]=i.useState(null),[V,R]=i.useState(null),[z,q]=i.useState(null),[F,J]=i.useState([]),[k,l]=i.useState([]),[G,j]=i.useState(""),[B,e]=i.useState(!0),[p,o]=i.useState(null),[C,U]=i.useState(0),[I,ee]=i.useState(null),D=i.useRef(0),H=i.useRef(!1),M=i.useCallback(m=>O(null,null,function*(){var x,b;if(!(u!=null&&u.user)||!s||!r||C===0)return;P.debug(`Updating progress for ${r} ${s} at time ${m}`,{episode:I});const t={user_id:u.user.id,tmdb_id:Number(s),media_type:r,progress_seconds:Math.round(m),total_seconds:Math.round(C),updated_at:new Date().toISOString()};if(r==="tv"||r==="anime")if(I)t.season_number=I.season,t.episode_number=I.episode;else return;try{const{error:c}=yield _.from("playback_progress").upsert(t,{onConflict:"user_id,tmdb_id,media_type,season_number,episode_number"});if(c)P.error("Error upserting playback_progress:",c);else try{window.dispatchEvent(new CustomEvent("playback-progress-saved",{detail:{tmdbId:Number(s),mediaType:r,season:(x=t.season_number)!=null?x:null,episode:(b=t.episode_number)!=null?b:null,time:t.progress_seconds}})),P.debug("Dispatched playback-progress-saved event",{tmdbId:Number(s),mediaType:r,season:t.season_number,episode:t.episode_number})}catch(d){P.error("Failed to dispatch playback-progress-saved event",d)}}catch(c){P.error("Exception while updating progress:",c)}}),[u,s,r,C,I]),te=i.useCallback(we(M,5e3),[M]);i.useEffect(()=>{const m=()=>{D.current>0&&!H.current&&(M(D.current),H.current=!0)},t=x=>{m()};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t),m()}},[M]),i.useEffect(()=>{const m=()=>O(null,null,function*(){var t;try{if(D.current>0&&(yield M(D.current)),(r==="tv"||r==="anime")&&s)try{const{data:b,error:c}=yield _.from("catalog_items").select("jellyfin_id").eq("tmdb_id",Number(s)).eq("media_type","tv").single();if(!c&&(b!=null&&b.jellyfin_id)){const{data:d,error:n}=yield _.functions.invoke("get-jellyfin-next-up",{body:{seriesJellyfinId:b.jellyfin_id}});if(!n&&(d!=null&&d.seasonNumber)&&(d!=null&&d.episodeNumber)){const N=new URLSearchParams;N.set("season",String(d.seasonNumber)),N.set("episode",String(d.episodeNumber)),v&&N.set("audioStreamIndex",v),w&&N.set("subtitleStreamIndex",w),f(`/media/${r}/${s}/play?${N.toString()}`,{replace:!0,state:{from:((t=g.state)==null?void 0:t.from)||-1}})}}}catch(x){}}catch(x){P.error("Error saving progress on playback-ended:",x)}});return window.addEventListener("playback-ended",m),()=>{window.removeEventListener("playback-ended",m)}},[r,s,f,v,w,g.state,M]);const re=m=>{D.current=m,te(m)},se=m=>{U(m)};return i.useEffect(()=>{O(null,null,function*(){if(!s||!r){o("ID de média ou type manquant."),e(!1);return}e(!0),o(null);try{const t=h.get("season"),x=h.get("episode"),b=r==="anime"?"tv":r;let c=t?Number(t):null,d=x?Number(x):null;if(b==="tv"&&(c===null||d===null)){const{data:n,error:N}=yield _.from("catalog_items").select("jellyfin_id").eq("tmdb_id",Number(s)).eq("media_type",b).single();if(N||!n||!n.jellyfin_id)throw new Error("Cette série n'a pas été trouvée dans votre catalogue Jellyfin.");const{data:E,error:$}=yield _.functions.invoke("get-jellyfin-next-up",{body:{seriesJellyfinId:n.jellyfin_id}});if($)throw $;if(!E)throw new Error("Impossible de déterminer le prochain épisode à regarder.");c=E.seasonNumber,d=E.episodeNumber}if(b==="tv"&&c!==null&&d!==null){const{data:n,error:N}=yield _.functions.invoke("get-jellyfin-episode-stream-url",{body:{seriesTmdbId:Number(s),seasonNumber:c,episodeNumber:d,audioStreamIndex:v,subtitleStreamIndex:w}});if(N)throw N;if(n.error)throw new Error(n.error);j(n.title||`S${c} E${d}`),ee({season:c,episode:d}),A(n.streamUrl),R(n.container),q(n.chapters),J(n.audioTracks||[]),l(n.subtitleTracks||[])}else{const{data:n,error:N}=yield _.from("catalog_items").select("jellyfin_id, title").eq("tmdb_id",Number(s)).eq("media_type",b).single();if(N||!n||!n.jellyfin_id)throw new Error("Ce média n'a pas été trouvé dans votre catalogue local. Veuillez lancer une synchronisation Jellyfin depuis le panneau d'administration.");j(n.title);const{data:E,error:$}=yield _.functions.invoke("get-jellyfin-stream-url",{body:{itemId:n.jellyfin_id,audioStreamIndex:v,subtitleStreamIndex:w}});if($)throw $;if(E.error)throw new Error(E.error);A(E.streamUrl),R(E.container),q(E.chapters),J(E.audioTracks||[]),l(E.subtitleTracks||[])}}catch(t){console.error("Error fetching stream URL:",t);const x="Une erreur est survenue lors du chargement de la vidéo.";let b=t.message||"";if(t instanceof fe)try{const c=yield t.context.json();c.error&&(b=c.error)}catch(c){}o(`${x} Détails: ${b}`)}finally{e(!1)}})},[s,r,h,v,w]),S?a.jsx("div",{className:"bg-black h-screen w-screen flex flex-col",children:a.jsx("main",{className:"flex-grow flex items-center justify-center",children:a.jsx("div",{className:"container mx-auto px-4",children:a.jsxs(Q,{variant:"destructive",children:[a.jsx(Y,{className:"h-4 w-4"}),a.jsx(W,{children:"Erreur de configuration Jellyfin"}),a.jsx(X,{children:S})]})})})}):a.jsx("div",{className:"bg-black h-screen w-screen flex flex-col",children:a.jsxs("main",{className:"flex-grow flex items-center justify-center",children:[B&&a.jsx(me,{className:"w-full h-full"}),p&&!B&&a.jsx("div",{className:"container mx-auto px-4",children:a.jsxs(Q,{variant:"destructive",children:[a.jsx(Y,{className:"h-4 w-4"}),a.jsx(W,{children:T("error")}),a.jsx(X,{children:p})]})}),L&&!B&&a.jsx(ye,{src:L,container:V,title:G,chapters:z,audioTracks:F,subtitleTracks:k,onTimeUpdate:re,onDurationChange:se,startTime:y!==null?Number(y):null,selectedSubtitleIndex:w,onBack:()=>{var t;const m=((t=g.state)==null?void 0:t.from)||-1;f(m,{replace:!0})}})]})})};function we(r,s){let f=null;return(...g)=>{f&&clearTimeout(f),f=setTimeout(()=>r(...g),s)}}export{Ie as default};
//# sourceMappingURL=PlayerPage-DT_FoeFs.js.map
