{"version":3,"file":"Jellyfin-CxUSWX-n.js","sources":["../../src/components/admin/JellyfinSettings.tsx","../../src/pages/admin/Jellyfin.tsx"],"sourcesContent":["import { useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport * as z from 'zod';\nimport { supabase } from '@/integrations/supabase/client';\nimport { showSuccess, showError, showLoading, dismissToast } from '@/utils/toast';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { Film, RefreshCw, Loader2 } from 'lucide-react';\n\nconst jellyfinSettingsSchema = z.object({\n  url: z.string().url({ message: \"Veuillez entrer une URL valide.\" }),\n  api_key: z.string().min(1, { message: \"La clé API est requise.\" }),\n});\n\nconst JellyfinSettings = () => {\n  const { t } = useTranslation();\n  const [loading, setLoading] = useState(true);\n  const [isSyncing, setIsSyncing] = useState(false);\n\n  const form = useForm<z.infer<typeof jellyfinSettingsSchema>>({\n    resolver: zodResolver(jellyfinSettingsSchema),\n    defaultValues: {\n      url: '',\n      api_key: '',\n    },\n  });\n\n  useEffect(() => {\n    const fetchSettings = async () => {\n      setLoading(true);\n      const { data, error } = await supabase\n        .from('jellyfin_settings')\n        .select('*')\n        .single();\n\n      if (error && error.code !== 'PGRST116') { // Ignore \"no rows found\" error\n        showError(t('error_loading_jellyfin_settings'));\n        console.error(error);\n      } else if (data) {\n        form.reset({\n          url: data.url || '',\n          api_key: data.api_key || '',\n        });\n      }\n      setLoading(false);\n    };\n    fetchSettings();\n  }, [form, t]);\n\n  const onSubmit = async (values: z.infer<typeof jellyfinSettingsSchema>) => {\n    const { error } = await supabase\n      .from('jellyfin_settings')\n      .upsert({ id: 1, ...values, updated_at: new Date().toISOString() }, { onConflict: 'id' });\n\n    if (error) {\n      showError(t('error_saving_jellyfin_settings') || t('error_saving_settings'));\n    } else {\n      showSuccess(t('settings_saved_successfully'));\n    }\n  };\n\n  const handleSync = async () => {\n    setIsSyncing(true);\n    const toastId = showLoading('Initialisation de la synchronisation...');\n    let totalItemsProcessed = 0;\n\n    try {\n      // 1. Get the list of libraries (views)\n      const { data: viewsResponse, error: viewsError } = await supabase.functions.invoke('sync-jellyfin', { body: {} });\n      if (viewsError) throw viewsError;\n      // The function now returns structured { ok: boolean, ... }\n      if (!viewsResponse || viewsResponse.ok === false) {\n        const msg = (viewsResponse && viewsResponse.error) ? viewsResponse.error : 'Unknown error while listing views';\n        throw new Error(msg);\n      }\n      const views = viewsResponse.views;\n\n      // 2. Loop through each library\n      for (const [index, view] of views.entries()) {\n        let startIndex = 0;\n        let isViewDone = false;\n\n        while (!isViewDone) {\n          showLoading(`[${index + 1}/${views.length}] Sync: '${view.name}' (${startIndex}/${view.totalItems})`, { id: toastId });\n\n          // 3. Invoke function for each page\n          const { data: pageResponse, error: pageError } = await supabase.functions.invoke('sync-jellyfin', {\n            body: { viewId: view.id, startIndex: startIndex }\n          });\n          if (pageError) throw pageError;\n          if (!pageResponse || pageResponse.ok === false) {\n            const msg = (pageResponse && pageResponse.error) ? pageResponse.error : 'Unknown error while fetching page';\n            throw new Error(msg);\n          }\n\n          totalItemsProcessed += pageResponse.itemsProcessed || 0;\n          startIndex = pageResponse.nextStartIndex || 0;\n          isViewDone = !!pageResponse.isViewDone;\n        }\n      }\n\n      dismissToast(toastId);\n      showSuccess(`Synchronisation terminée ! ${totalItemsProcessed} éléments traités.`);\n\n    } catch (error: any) {\n      dismissToast(toastId);\n      console.error('Sync error:', error);\n      showError(`Erreur de synchronisation: ${error.message || String(error)}`);\n    } finally {\n      setIsSyncing(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <Card>\n        <CardHeader>\n          <Skeleton className=\"h-6 w-48\" />\n          <Skeleton className=\"h-4 w-full\" />\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Skeleton className=\"h-10 w-full\" />\n          <Skeleton className=\"h-10 w-full\" />\n          <Skeleton className=\"h-10 w-24\" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Film className=\"h-5 w-5\" />\n          {t('jellyfin_settings')}\n        </CardTitle>\n        <CardDescription>{t('jellyfin_settings_desc')}</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"url\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>{t('jellyfin_url')}</FormLabel>\n                  <FormControl>\n                    <Input {...field} placeholder={t('jellyfin_url_placeholder')} />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n            <FormField\n              control={form.control}\n              name=\"api_key\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>{t('jellyfin_api_key')}</FormLabel>\n                  <FormControl>\n                    <Input type=\"password\" {...field} placeholder={t('jellyfin_api_key_placeholder')} />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n            <div className=\"flex items-center gap-2 pt-2\">\n              <Button type=\"submit\" disabled={form.formState.isSubmitting || isSyncing}>\n                {form.formState.isSubmitting ? t('saving') : t('save_jellyfin_settings')}\n              </Button>\n              <Button type=\"button\" variant=\"outline\" onClick={handleSync} disabled={isSyncing || form.formState.isSubmitting}>\n                {isSyncing ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <RefreshCw className=\"mr-2 h-4 w-4\" />\n                )}\n                Synchroniser\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default JellyfinSettings;","import { useTranslation } from 'react-i18next';\nimport { motion } from 'framer-motion';\nimport JellyfinSettings from '@/components/admin/JellyfinSettings';\nimport WebhookInstructions from '@/components/admin/WebhookInstructions';\n\nconst JellyfinAdminPage = () => {\n  const { t } = useTranslation();\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.5, ease: \"easeInOut\" }}\n      className=\"space-y-8\"\n    >\n      <div className=\"space-y-2\">\n        <h1 className=\"text-3xl font-bold tracking-tight\">{t('jellyfin_tab_title')}</h1>\n        <p className=\"text-muted-foreground\">{t('jellyfin_tab_desc')}</p>\n      </div>\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 items-start\">\n        <JellyfinSettings />\n        <WebhookInstructions />\n      </div>\n    </motion.div>\n  );\n};\n\nexport default JellyfinAdminPage;"],"names":["jellyfinSettingsSchema","z.object","z.string","JellyfinSettings","t","useTranslation","loading","setLoading","useState","isSyncing","setIsSyncing","form","useForm","zodResolver","useEffect","__async","data","error","supabase","showError","onSubmit","values","__spreadProps","__spreadValues","showSuccess","handleSync","toastId","showLoading","totalItemsProcessed","viewsResponse","viewsError","msg","views","index","view","startIndex","isViewDone","pageResponse","pageError","dismissToast","Card","jsxs","CardHeader","jsx","Skeleton","CardContent","CardTitle","Film","CardDescription","Form","FormField","field","FormItem","FormLabel","FormControl","Input","FormMessage","Button","Loader2","RefreshCw","JellyfinAdminPage","motion","WebhookInstructions"],"mappings":"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"}