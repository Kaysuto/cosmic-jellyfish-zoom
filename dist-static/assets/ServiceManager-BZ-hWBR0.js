var ae=Object.defineProperty,te=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var q=(s,a,i)=>a in s?ae(s,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[a]=i,p=(s,a)=>{for(var i in a||(a={}))ie.call(a,i)&&q(s,i,a[i]);if(H)for(var i of H(a))oe.call(a,i)&&q(s,i,a[i]);return s},g=(s,a)=>te(s,ne(a));var _=(s,a,i)=>new Promise((m,t)=>{var u=x=>{try{h(i.next(x))}catch(l){t(l)}},n=x=>{try{h(i.throw(x))}catch(l){t(l)}},h=x=>x.done?m(x.value):Promise.resolve(x.value).then(u,n);h((i=i.apply(s,a)).next())});import{j as e}from"./ui-DslYdUPK.js";import{r as v}from"./router-42GXI50n.js";import{u as le}from"./useServices-CHToQZU2.js";import{u as W,B as f,a as ce,C as z,n as B,S as $,p as V,m as de,o as me,O as ue,x as xe,e as he,V as pe,W as je,Y as ge,a0 as R,_ as fe,A as _e,f as ve,g as we,h as be,i as Ce,j as Ne,k as ye,l as De,s as j,d as w,a8 as Se,K as F,a9 as Te}from"./index-Cw6WSGfP.js";import{u as ke,t as Ie,F as Le,a as b,b as C,c as N,d as y,e as D,g as Z,o as Fe,p as Oe,s as O,n as Ae,l as Ee}from"./form-Ba3HuSxU.js";import{I as A}from"./input-B7M3MPRI.js";import{T as Me}from"./textarea-BGhclJcN.js";import{T as Pe,a as Re,b as K,c as S,d as Ue,e as T}from"./table-BD6NPv27.js";import{D as He,a as qe,b as ze,c as Be,d as $e}from"./dialog-DtG0Tqk0.js";import{C as Ve}from"./circle-plus-CGDpU3lh.js";import{C as Ze}from"./chevron-up-3WKbjQ45.js";import{E as Ke}from"./ellipsis-pwK6sJe6.js";import{S as We}from"./square-pen-ltNotjoP.js";import{Z as Ye}from"./zap-EjhYcE0-.js";import"./vendor-aQ18W7Az.js";import"./streaming-fF1zHaJi.js";import"./utils-D-N2hrcs.js";import"./label-BjJg9FZ3.js";const Ge=Fe({name:O().min(1,{message:"Le nom est requis"}),description:O().optional(),url:O().url({message:"L'URL n'est pas valide"}).optional().or(Ee("")),ip_address:O().optional().nullable(),port:Oe(s=>s===""||s===null||s===void 0?void 0:Number(s),Ae({invalid_type_error:"Le port doit être un nombre."}).positive({message:"Le port doit être un nombre positif."}).int().min(1,"Le port doit être supérieur à 0.").max(65535,"Le port doit être inférieur à 65536.").optional())}).refine(s=>!!s.ip_address==!!s.port,{message:"L'adresse IP et le port doivent être fournis ensemble, ou aucun des deux.",path:["port"]}),Je=({service:s,onSubmit:a,onCancel:i,isSubmitting:m})=>{const{t}=W(),u=ke({resolver:Ie(Ge),defaultValues:{name:(s==null?void 0:s.name)||"",description:(s==null?void 0:s.description)||"",url:(s==null?void 0:s.url)||"",ip_address:(s==null?void 0:s.ip_address)||null,port:(s==null?void 0:s.port)||void 0}});return e.jsx(Le,g(p({},u),{children:e.jsxs("form",{onSubmit:u.handleSubmit(a),className:"space-y-4",children:[e.jsx(b,{control:u.control,name:"name",render:({field:n})=>e.jsxs(C,{children:[e.jsx(N,{children:t("title")}),e.jsx(y,{children:e.jsx(A,p({},n))}),e.jsx(D,{})]})}),e.jsx(b,{control:u.control,name:"description",render:({field:n})=>e.jsxs(C,{children:[e.jsx(N,{children:t("description")}),e.jsx(y,{children:e.jsx(Me,p({},n))}),e.jsx(D,{})]})}),e.jsx(b,{control:u.control,name:"url",render:({field:n})=>e.jsxs(C,{children:[e.jsx(N,{children:"URL de surveillance"}),e.jsx(y,{children:e.jsx(A,g(p({},n),{placeholder:"https://example.com"}))}),e.jsx(D,{}),e.jsx("p",{className:"text-xs text-muted-foreground",children:`Laissez vide si le service n'a pas d'URL à surveiller. Le statut sera défini sur "En maintenance".`})]})}),e.jsx(b,{control:u.control,name:"ip_address",render:({field:n})=>e.jsxs(C,{children:[e.jsx(N,{children:"Adresse IP (Optionnel)"}),e.jsx(y,{children:e.jsx(A,g(p({},n),{value:n.value||"",placeholder:"123.45.67.89"}))}),e.jsx(Z,{children:"IP du serveur d'origine pour contourner Cloudflare pour les vérifications."}),e.jsx(D,{})]})}),e.jsx(b,{control:u.control,name:"port",render:({field:n})=>{var h;return e.jsxs(C,{children:[e.jsx(N,{children:"Port (Optionnel)"}),e.jsx(y,{children:e.jsx(A,g(p({},n),{value:(h=n.value)!=null?h:"",onChange:n.onChange,placeholder:"443"}))}),e.jsx(Z,{children:"Port du serveur d'origine. Doit être utilisé avec l'adresse IP."}),e.jsx(D,{})]})}}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(f,{type:"button",variant:"ghost",onClick:i,disabled:m,children:t("cancel")}),e.jsx(f,{type:"submit",disabled:m,children:t(m?"saving":"save")})]})]})}))},gs=()=>{const{t:s}=W(),{services:a,loading:i,refreshServices:m}=le(),{session:t}=ce(),[u,n]=v.useState(!1),[h,x]=v.useState(!1),[l,E]=v.useState(null),[Y,M]=v.useState(!1),[k,P]=v.useState(null),G=r=>_(null,null,function*(){const c=Se(s("checking_status_now"));try{const{error:o}=yield j.functions.invoke("immediate-health-check",{body:{service_id:r}});if(o)throw o;F(s("check_complete_status_soon")),setTimeout(m,2e3)}catch(o){w(`${s("error_during_check")}: ${o.message}`)}finally{Te(c)}}),I={operational:{text:s("operational"),className:"bg-green-500/20 text-green-500 border-green-500/30"},degraded:{text:s("degraded"),className:"bg-yellow-500/20 text-yellow-500 border-yellow-500/30"},downtime:{text:s("downtime"),className:"bg-red-500/20 text-red-500 border-red-500/30"},maintenance:{text:"En maintenance",className:"bg-gray-500/20 text-gray-500 border-gray-500/30"}},U=(r,c)=>_(null,null,function*(){const o=a[r],d=c==="up"?r-1:r+1,L=a[d];if(!o||!L)return;const{error:re}=yield j.rpc("swap_service_positions",{service_id_1:o.id,service_id_2:L.id});re?w("Erreur lors de la réorganisation."):m()}),J=r=>_(null,null,function*(){x(!0);const c=r.url&&r.url.trim()!=="",o=g(p({},r),{url:c?r.url:null,status:l?l.status:c?"operational":"maintenance",updated_at:new Date().toISOString(),position:l?l.position:a.length>0?Math.max(...a.map(d=>d.position))+1:1});if(l){const{error:d}=yield j.from("services").update(o).eq("id",l.id);d?w(s("error_saving_service")):(F(s("service_saved_successfully")),t!=null&&t.user.id&&(yield j.from("audit_logs").insert({user_id:t.user.id,action:"service_updated",details:{service_id:l.id,name:r.name}})),m())}else{const{data:d,error:L}=yield j.from("services").insert(o).select().single();L?w(s("error_saving_service")):(F(s("service_saved_successfully")),d&&(t!=null&&t.user.id)&&(yield j.from("audit_logs").insert({user_id:t.user.id,action:"service_created",details:{service_id:d.id,name:r.name}})),m())}n(!1),E(null),x(!1)}),Q=r=>{P(r),M(!0)},X=()=>_(null,null,function*(){var o;if(!k)return;const r=(o=a.find(d=>d.id===k))==null?void 0:o.name,{error:c}=yield j.from("services").delete().eq("id",k);c?w(s("error_deleting_service")):(F(s("service_deleted_successfully")),t!=null&&t.user.id&&(yield j.from("audit_logs").insert({user_id:t.user.id,action:"service_deleted",details:{service_id:k,name:r}})),m()),M(!1),P(null)}),ee=()=>{E(null),n(!0)},se=r=>{E(r),n(!0)};return i?e.jsxs(z,{children:[e.jsx(B,{children:e.jsx($,{className:"h-8 w-48"})}),e.jsx(V,{children:e.jsx($,{className:"h-64 w-full"})})]}):e.jsxs(de.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeInOut"},children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex flex-row items-center justify-between",children:[e.jsx(me,{children:s("manage_services")}),e.jsxs(f,{onClick:ee,children:[e.jsx(Ve,{className:"mr-2 h-4 w-4"}),s("create_service")]})]}),e.jsx(V,{children:e.jsxs(Pe,{children:[e.jsx(Re,{children:e.jsxs(K,{children:[e.jsx(S,{className:"w-[60px]",children:"Ordre"}),e.jsx(S,{children:s("service")}),e.jsx(S,{children:s("status")}),e.jsx(S,{children:"URL"}),e.jsx(S,{className:"text-right",children:s("actions")})]})}),e.jsx(Ue,{children:a.map((r,c)=>{var o,d;return e.jsxs(K,{children:[e.jsx(T,{children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>U(c,"up"),disabled:c===0,children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>U(c,"down"),disabled:c===a.length-1,children:e.jsx(ue,{className:"h-4 w-4"})})]})}),e.jsxs(T,{children:[e.jsx("div",{className:"font-medium",children:s(r.name.toLowerCase().replace(/ /g,"_"))}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r.description})]}),e.jsx(T,{children:e.jsx(xe,{variant:"outline",className:he("border",((o=I[r.status])==null?void 0:o.className)||I.maintenance.className),children:((d=I[r.status])==null?void 0:d.text)||I.maintenance.text})}),e.jsx(T,{children:r.url?e.jsx("span",{className:"text-xs text-green-600",children:"✓ Surveillé"}):e.jsx("span",{className:"text-xs text-gray-500",children:"Non surveillé"})}),e.jsx(T,{className:"text-right",children:e.jsxs(pe,{modal:!1,children:[e.jsx(je,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",children:e.jsx(Ke,{className:"h-4 w-4"})})}),e.jsxs(ge,{align:"end",children:[e.jsxs(R,{onClick:()=>se(r),children:[e.jsx(We,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:s("edit")})]}),e.jsxs(R,{onClick:()=>G(r.id),disabled:!r.url,children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:s("check_status")})]}),e.jsxs(R,{onClick:()=>Q(r.id),className:"text-destructive",children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:s("delete")})]})]})]})})]},r.id)})})]})})]}),e.jsx(He,{open:u,onOpenChange:n,children:e.jsxs(qe,{className:"sm:max-w-lg",children:[e.jsxs(ze,{children:[e.jsx(Be,{children:s(l?"edit_service":"create_service")}),e.jsx($e,{children:s(l?"edit_service_desc":"create_service_desc")})]}),e.jsx(Je,{service:l,onSubmit:J,onCancel:()=>n(!1),isSubmitting:h})]})}),e.jsx(_e,{open:Y,onOpenChange:M,children:e.jsxs(ve,{children:[e.jsxs(we,{children:[e.jsx(be,{children:s("confirm_delete_title")}),e.jsx(Ce,{children:s("confirm_delete_service")})]}),e.jsxs(Ne,{children:[e.jsx(ye,{onClick:()=>P(null),children:s("cancel")}),e.jsx(De,{onClick:X,className:"bg-destructive hover:bg-destructive/90",children:s("delete")})]})]})})]})};export{gs as default};
//# sourceMappingURL=ServiceManager-BZ-hWBR0.js.map
