var me=Object.defineProperty,ue=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable;var q=(a,s,r)=>s in a?me(a,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[s]=r,w=(a,s)=>{for(var r in s||(s={}))fe.call(s,r)&&q(a,r,s[r]);if(H)for(var r of H(s))xe.call(s,r)&&q(a,r,s[r]);return a},D=(a,s)=>ue(a,he(s));var g=(a,s,r)=>new Promise((l,d)=>{var o=i=>{try{t(r.next(i))}catch(n){d(n)}},m=i=>{try{t(r.throw(i))}catch(n){d(n)}},t=i=>i.done?l(i.value):Promise.resolve(i.value).then(o,m);t((r=r.apply(a,s)).next())});import{j as e}from"./ui-DslYdUPK.js";import{u as pe}from"./useUserById-Bt1QZYlT.js";import{u as A,v as ge,w as je,C as I,n as F,D as _e,E as ve,G as be,H as we,_ as Ne,p as U,x as ye,M as Se,A as W,f as X,g as Y,h as ee,i as ae,j as se,k as re,l as te,ae as ie,s as h,d as _,K as N,a as M,o as le,I as ne,B as E,S as j,m as Ae}from"./index-Cw6WSGfP.js";import{r as u,h as Ce,u as De}from"./router-42GXI50n.js";import{L as k}from"./loader-circle-BQi2R5hk.js";import{S as ke}from"./square-pen-ltNotjoP.js";import{f as Ie}from"./format-ulCIpsJ0.js";import{S as Fe,U as Ue}from"./UpdateProfileForm-BcaR0493.js";import{o as Me,s as G,u as Ee,t as Oe,F as Le,a as z,b as V,c as Z,d as K,e as J}from"./form-Ba3HuSxU.js";import{I as Q}from"./input-B7M3MPRI.js";import{M as $e}from"./mail-_uYRG5vJ.js";import{S as Pe}from"./shield-off-VgMbnC9R.js";import{A as Re}from"./arrow-left-Db81hexG.js";import"./vendor-aQ18W7Az.js";import"./streaming-fF1zHaJi.js";import"./utils-D-N2hrcs.js";import"./label-BjJg9FZ3.js";const Te=({profile:a,session:s,onProfileUpdate:r})=>{var O,L,$,P;const{t:l,i18n:d}=A(),o=d.language==="fr"?ge:je,m=u.useRef(null),[t,i]=u.useState(!1),[n,y]=u.useState(!1),[c,p]=u.useState(!1),f=((O=s==null?void 0:s.user)==null?void 0:O.id)===a.id,C=()=>{var x;f&&((x=m.current)==null||x.click())},oe=x=>g(null,null,function*(){var B;const v=(B=x.target.files)==null?void 0:B[0];if(!v||!f)return;i(!0);const S=`${Date.now()}_${v.name}`,b=`${a.id}/${S}`,{error:R}=yield h.storage.from("avatars").upload(b,v);if(R){_(R.message),i(!1);return}const{data:{publicUrl:de}}=h.storage.from("avatars").getPublicUrl(b),{error:T}=yield h.from("profiles").update({avatar_url:de,updated_at:new Date().toISOString()}).eq("id",a.id);T?_(T.message):(N("Avatar mis à jour avec succès !"),r()),i(!1)}),ce=()=>g(null,null,function*(){if(!(!a.avatar_url||!f)){y(!0);try{const v=new URL(a.avatar_url).pathname.split("/avatars/")[1],{error:S}=yield h.storage.from("avatars").remove([v]);if(S)throw S;const{error:b}=yield h.from("profiles").update({avatar_url:null,updated_at:new Date().toISOString()}).eq("id",a.id);if(b)throw b;N("Avatar supprimé avec succès."),r()}catch(x){_(`Erreur lors de la suppression de l'avatar: ${x.message}`)}finally{y(!1),p(!1)}}});return e.jsxs(e.Fragment,{children:[e.jsxs(I,{className:"overflow-hidden",children:[e.jsx(F,{className:"bg-muted/30 p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative group",children:[e.jsxs(_e,{className:"h-20 w-20 border-4 border-background",children:[e.jsx(ve,{src:a.avatar_url||be(a.email,160)}),e.jsxs(we,{className:"text-3xl",children:[(L=a.first_name)==null?void 0:L.charAt(0),($=a.last_name)==null?void 0:$.charAt(0)]})]}),f&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:C,disabled:t||n,className:"p-2 text-white hover:text-blue-400 disabled:opacity-50",title:"Modifier l'avatar",children:t?e.jsx(k,{className:"h-5 w-5 animate-spin"}):e.jsx(ke,{className:"h-5 w-5"})}),a.avatar_url&&e.jsx("button",{onClick:()=>p(!0),disabled:t||n,className:"p-2 text-white hover:text-red-400 disabled:opacity-50",title:"Supprimer l'avatar",children:n?e.jsx(k,{className:"h-5 w-5 animate-spin"}):e.jsx(Ne,{className:"h-5 w-5"})})]}),e.jsx("input",{type:"file",ref:m,onChange:oe,className:"hidden",accept:"image/png, image/jpeg, image/gif",disabled:t||!f})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground",children:[a.first_name," ",a.last_name]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.email})]})]})}),e.jsxs(U,{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xs font-semibold text-muted-foreground mb-1",children:l("role")}),e.jsx(ye,{variant:a.role==="admin"?"default":"secondary",children:a.role==="admin"?l("admin_role"):l("user_role")})]}),f&&((P=s==null?void 0:s.user)==null?void 0:P.created_at)&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-xs font-semibold text-muted-foreground mb-1",children:l("member_since")}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-foreground",children:[e.jsx(Se,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:Ie(new Date(s.user.created_at),"d MMMM yyyy",{locale:o})})]})]})]})]}),e.jsx(W,{open:c,onOpenChange:p,children:e.jsxs(X,{children:[e.jsxs(Y,{children:[e.jsx(ee,{children:"Supprimer l'avatar ?"}),e.jsx(ae,{children:"Cette action est irréversible. Votre avatar sera supprimé et remplacé par l'image par défaut de Gravatar."})]}),e.jsxs(se,{children:[e.jsx(re,{disabled:n,children:"Annuler"}),e.jsxs(te,{onClick:ce,disabled:n,className:ie({variant:"destructive"}),children:[n?e.jsx(k,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Supprimer"]})]})]})})]})},Be=new RegExp(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),He=({user:a})=>{const{t:s,i18n:r}=A(),{session:l}=M(),d=u.useMemo(()=>Me({email:G().regex(Be,{message:s("invalid_email")}),password:G().optional()}),[s]),o=Ee({resolver:Oe(d),values:{email:a.email||""}});u.useEffect(()=>{Object.keys(o.formState.errors).length>0&&o.trigger()},[r.language,o]);const m=t=>g(null,null,function*(){if(!(l!=null&&l.user))return;const i={};if(t.email&&t.email!==a.email&&(i.email=t.email),t.password&&(i.password=t.password),Object.keys(i).length===0){N("Aucune modification à enregistrer.");return}try{const{error:n}=yield h.functions.invoke("update-user-details",{body:{userId:a.id,attributes:i}});if(n)throw n;N("Détails de l'utilisateur mis à jour avec succès."),yield h.from("audit_logs").insert({user_id:l.user.id,action:"admin_user_details_updated",details:{target_user_id:a.id,changes:i}}),o.reset(D(w({},t),{password:""}))}catch(n){_(`Erreur: ${n.message}`)}});return e.jsxs(I,{children:[e.jsxs(F,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5"})," ",s("change_email_or_password")]}),e.jsx(ne,{children:s("update_user_email_password_desc")})]}),e.jsx(U,{children:e.jsx(Le,D(w({},o),{children:e.jsxs("form",{onSubmit:o.handleSubmit(m),className:"space-y-4",children:[e.jsx(z,{control:o.control,name:"email",render:({field:t})=>e.jsxs(V,{children:[e.jsx(Z,{children:s("email_address")}),e.jsx(K,{children:e.jsx(Q,w({type:"email"},t))}),e.jsx(J,{})]})}),e.jsx(z,{control:o.control,name:"password",render:({field:t})=>e.jsxs(V,{children:[e.jsx(Z,{children:s("new_password_optional")}),e.jsx(K,{children:e.jsx(Q,w({type:"password"},t))}),e.jsx(J,{})]})}),e.jsx(E,{type:"submit",disabled:o.formState.isSubmitting,children:s("save_changes")})]})}))})]})},qe=({user:a})=>{const{t:s}=A(),{session:r}=M(),[l,d]=u.useState(!1),[o,m]=u.useState(!0),[t,i]=u.useState(!1),n=u.useCallback(()=>g(null,null,function*(){m(!0);try{const{data:c,error:p}=yield h.functions.invoke("get-user-mfa-factors",{body:{userId:a.id}});if(p)throw p;if(c&&c.factors){const f=c.factors.find(C=>C.status==="verified");d(!!f)}else d(!1)}catch(c){_(c.message)}finally{m(!1)}}),[a.id]);u.useEffect(()=>{n()},[n]);const y=()=>g(null,null,function*(){if(r!=null&&r.user)try{const{error:c}=yield h.functions.invoke("admin-unenroll-mfa",{body:{userId:a.id}});if(c)throw c;N(s("mfa_disabled_for_user",{email:a.email})),yield h.from("audit_logs").insert({user_id:r.user.id,action:"admin_mfa_disabled",details:{target_user_id:a.id,email:a.email}}),n()}catch(c){_(`${s("error_disabling_mfa")}: ${c.message}`)}finally{i(!1)}});return e.jsxs(e.Fragment,{children:[e.jsxs(I,{children:[e.jsxs(F,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5"})," ",s("mfa_title")]}),e.jsx(ne,{children:s("manage_user_mfa_desc")})]}),e.jsx(U,{children:o?e.jsx(j,{className:"h-10 w-32"}):l?e.jsxs(E,{variant:"destructive",onClick:()=>i(!0),children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),s("disable_mfa")]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:s("user_mfa_disabled")})})]}),e.jsx(W,{open:t,onOpenChange:i,children:e.jsxs(X,{children:[e.jsxs(Y,{children:[e.jsx(ee,{children:s("confirm_disable_mfa_title")}),e.jsx(ae,{children:s("confirm_disable_mfa_desc",{email:a.email})})]}),e.jsxs(se,{children:[e.jsx(re,{children:s("cancel")}),e.jsx(te,{onClick:y,className:ie({variant:"destructive"}),children:s("disable_mfa")})]})]})})]})},oa=()=>{const{userId:a}=Ce(),s=De(),{t:r}=A(),{user:l,loading:d,refreshUser:o}=pe(a),{session:m}=M(),t=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsx(j,{className:"h-10 w-32"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsx(j,{className:"h-56 w-full"})}),e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(j,{className:"h-56 w-full"}),e.jsx(j,{className:"h-48 w-full"}),e.jsx(j,{className:"h-56 w-full"})]})]})]});return d?e.jsx(t,{}):l?e.jsxs(Ae.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeInOut"},className:"space-y-6",children:[e.jsxs(E,{variant:"outline",onClick:()=>s("/admin/users"),children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),r("back_to_users")]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 items-start",children:[e.jsx("div",{className:"lg:col-span-1 space-y-6",children:e.jsx(Te,{profile:l,session:m,onProfileUpdate:o})}),e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(Ue,{profile:l}),e.jsx(He,{user:l}),e.jsx(qe,{user:l})]})]})]}):e.jsx("div",{children:r("user_not_found")})};export{oa as default};
//# sourceMappingURL=EditUser-C09oNRgT.js.map
