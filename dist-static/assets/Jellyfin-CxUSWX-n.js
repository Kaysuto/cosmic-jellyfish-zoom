var z=Object.defineProperty,G=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var C=(e,i,r)=>i in e?z(e,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[i]=r,f=(e,i)=>{for(var r in i||(i={}))K.call(i,r)&&C(e,r,i[r]);if(I)for(var r of I(i))M.call(i,r)&&C(e,r,i[r]);return e},h=(e,i)=>G(e,H(i));var p=(e,i,r)=>new Promise((c,d)=>{var o=t=>{try{m(r.next(t))}catch(a){d(a)}},u=t=>{try{m(r.throw(t))}catch(a){d(a)}},m=t=>t.done?c(t.value):Promise.resolve(t.value).then(o,u);m((r=r.apply(e,i)).next())});import{j as s}from"./ui-DslYdUPK.js";import{r as _}from"./router-42GXI50n.js";import{u as Q,t as X,F as Y,a as F,b as E,c as $,d as L,e as R,o as Z,s as T}from"./form-Ba3HuSxU.js";import{u as W,C as P,n as D,S as j,p as V,o as ss,F as es,I as rs,B as U,s as y,d as S,a8 as A,a9 as B,K as J,m as ts}from"./index-Cw6WSGfP.js";import{I as O}from"./input-B7M3MPRI.js";import{L as is}from"./loader-circle-BQi2R5hk.js";import{R as ns}from"./refresh-cw-vuD0gYMD.js";import{W as as}from"./WebhookInstructions-CdQe4s68.js";import"./vendor-aQ18W7Az.js";import"./label-BjJg9FZ3.js";import"./utils-D-N2hrcs.js";import"./streaming-fF1zHaJi.js";import"./alert-C5VW6aHR.js";import"./triangle-alert-bjg6MAJf.js";const os=Z({url:T().url({message:"Veuillez entrer une URL valide."}),api_key:T().min(1,{message:"La clé API est requise."})}),ls=()=>{const{t:e}=W(),[i,r]=_.useState(!0),[c,d]=_.useState(!1),o=Q({resolver:X(os),defaultValues:{url:"",api_key:""}});_.useEffect(()=>{p(null,null,function*(){r(!0);const{data:a,error:n}=yield y.from("jellyfin_settings").select("*").single();n&&n.code!=="PGRST116"?(S(e("error_loading_jellyfin_settings")),console.error(n)):a&&o.reset({url:a.url||"",api_key:a.api_key||""}),r(!1)})},[o,e]);const u=t=>p(null,null,function*(){const{error:a}=yield y.from("jellyfin_settings").upsert(h(f({id:1},t),{updated_at:new Date().toISOString()}),{onConflict:"id"});a?S(e("error_saving_jellyfin_settings")||e("error_saving_settings")):J(e("settings_saved_successfully"))}),m=()=>p(null,null,function*(){d(!0);const t=A("Initialisation de la synchronisation...");let a=0;try{const{data:n,error:v}=yield y.functions.invoke("sync-jellyfin",{body:{}});if(v)throw v;if(!n||n.ok===!1){const x=n&&n.error?n.error:"Unknown error while listing views";throw new Error(x)}const b=n.views;for(const[x,g]of b.entries()){let w=0,k=!1;for(;!k;){A(`[${x+1}/${b.length}] Sync: '${g.name}' (${w}/${g.totalItems})`,{id:t});const{data:l,error:N}=yield y.functions.invoke("sync-jellyfin",{body:{viewId:g.id,startIndex:w}});if(N)throw N;if(!l||l.ok===!1){const q=l&&l.error?l.error:"Unknown error while fetching page";throw new Error(q)}a+=l.itemsProcessed||0,w=l.nextStartIndex||0,k=!!l.isViewDone}}B(t),J(`Synchronisation terminée ! ${a} éléments traités.`)}catch(n){B(t),console.error("Sync error:",n),S(`Erreur de synchronisation: ${n.message||String(n)}`)}finally{d(!1)}});return i?s.jsxs(P,{children:[s.jsxs(D,{children:[s.jsx(j,{className:"h-6 w-48"}),s.jsx(j,{className:"h-4 w-full"})]}),s.jsxs(V,{className:"space-y-4",children:[s.jsx(j,{className:"h-10 w-full"}),s.jsx(j,{className:"h-10 w-full"}),s.jsx(j,{className:"h-10 w-24"})]})]}):s.jsxs(P,{children:[s.jsxs(D,{children:[s.jsxs(ss,{className:"flex items-center gap-2",children:[s.jsx(es,{className:"h-5 w-5"}),e("jellyfin_settings")]}),s.jsx(rs,{children:e("jellyfin_settings_desc")})]}),s.jsx(V,{children:s.jsx(Y,h(f({},o),{children:s.jsxs("form",{onSubmit:o.handleSubmit(u),className:"space-y-4",children:[s.jsx(F,{control:o.control,name:"url",render:({field:t})=>s.jsxs(E,{children:[s.jsx($,{children:e("jellyfin_url")}),s.jsx(L,{children:s.jsx(O,h(f({},t),{placeholder:e("jellyfin_url_placeholder")}))}),s.jsx(R,{})]})}),s.jsx(F,{control:o.control,name:"api_key",render:({field:t})=>s.jsxs(E,{children:[s.jsx($,{children:e("jellyfin_api_key")}),s.jsx(L,{children:s.jsx(O,h(f({type:"password"},t),{placeholder:e("jellyfin_api_key_placeholder")}))}),s.jsx(R,{})]})}),s.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[s.jsx(U,{type:"submit",disabled:o.formState.isSubmitting||c,children:o.formState.isSubmitting?e("saving"):e("save_jellyfin_settings")}),s.jsxs(U,{type:"button",variant:"outline",onClick:m,disabled:c||o.formState.isSubmitting,children:[c?s.jsx(is,{className:"mr-2 h-4 w-4 animate-spin"}):s.jsx(ns,{className:"mr-2 h-4 w-4"}),"Synchroniser"]})]})]})}))})]})},bs=()=>{const{t:e}=W();return s.jsxs(ts.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.5,ease:"easeInOut"},className:"space-y-8",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:e("jellyfin_tab_title")}),s.jsx("p",{className:"text-muted-foreground",children:e("jellyfin_tab_desc")})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 items-start",children:[s.jsx(ls,{}),s.jsx(as,{})]})]})};export{bs as default};
//# sourceMappingURL=Jellyfin-CxUSWX-n.js.map
